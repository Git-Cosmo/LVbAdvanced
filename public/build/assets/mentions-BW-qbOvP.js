document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("[data-mention-enabled]").forEach(t=>{let e=null,n=-1,d="",s=-1;t.addEventListener("input",function(o){const a=this.selectionStart,m=this.value.substring(0,a).match(/@(\w*)$/);m?(s=a-m[0].length,d=m[1],d.length>=2?u(d):d.length===0&&f([])):r()}),t.addEventListener("keydown",function(o){if(!e||e.classList.contains("hidden"))return;const a=e.querySelectorAll("[data-mention-item]");o.key==="ArrowDown"?(o.preventDefault(),n=Math.min(n+1,a.length-1),h(a)):o.key==="ArrowUp"?(o.preventDefault(),n=Math.max(n-1,0),h(a)):o.key==="Enter"&&n>=0?(o.preventDefault(),a[n].click()):o.key==="Escape"&&r()});function u(o){fetch(`/forum/mentions/search?q=${encodeURIComponent(o)}`).then(a=>a.json()).then(a=>{t.getBoundingClientRect(),f(a)})}function f(o,a){if(e||(e=document.createElement("div"),e.className="absolute z-50 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto",e.style.minWidth="200px",t.parentElement.style.position="relative",t.parentElement.appendChild(e)),o.length===0){r();return}n=0,e.innerHTML=o.map((c,l)=>`
                <div data-mention-item data-user-id="${c.id}" data-user-name="${c.name}"
                     class="px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${l===0?"bg-gray-100 dark:bg-gray-700":""}">
                    <div class="font-medium text-gray-900 dark:text-white">@${c.name}</div>
                </div>
            `).join(""),e.style.top=t.offsetTop+t.offsetHeight+4+"px",e.style.left=t.offsetLeft+"px",e.classList.remove("hidden"),e.querySelectorAll("[data-mention-item]").forEach(c=>{c.addEventListener("click",function(){g(this.dataset.userName)})})}function r(){e&&e.classList.add("hidden"),n=-1}function h(o){o.forEach((a,c)=>{c===n?a.classList.add("bg-gray-100","dark:bg-gray-700"):a.classList.remove("bg-gray-100","dark:bg-gray-700")})}function g(o){const a=t.value,c=a.substring(0,s),l=a.substring(t.selectionStart);t.value=c+"@"+o+" "+l,t.selectionStart=t.selectionEnd=c.length+o.length+2,r(),t.focus()}document.addEventListener("click",function(o){o.target!==t&&!e?.contains(o.target)&&r()})})});function y(){document.querySelectorAll("[data-upload-attachment]").forEach(t=>{t.addEventListener("click",function(){const e=document.createElement("input");e.type="file",e.accept="*/*",e.multiple=!0,e.addEventListener("change",function(){const n=Array.from(this.files),d=t.dataset.attachableType,s=t.dataset.attachableId;n.forEach(u=>{b(u,d,s)})}),e.click()})})}function b(i,t,e){const n=new FormData;n.append("file",i),n.append("attachable_type",t),n.append("attachable_id",e);const d="upload-"+Date.now();v(d,i.name),fetch("/forum/attachments/upload",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:n}).then(s=>s.json()).then(s=>{s.success&&(E(s.attachment),p(d))}).catch(s=>{console.error("Upload failed:",s),p(d)})}function v(i,t){const e=document.getElementById("attachment-progress");if(!e)return;const n=document.createElement("div");n.id=i,n.className="p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-sm",n.textContent=`Uploading: ${t}...`,e.appendChild(n)}function p(i){const t=document.getElementById(i);t&&t.remove()}function E(i){const t=document.getElementById("attachments-list");if(!t)return;const e=document.createElement("div");e.className="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded",e.innerHTML=`
        <span class="flex-1 text-sm">ðŸ“Ž ${i.filename} (${i.size})</span>
        <button onclick="removeAttachment(${i.id})" class="text-red-600 hover:text-red-800">âœ•</button>
    `,t.appendChild(e)}document.addEventListener("DOMContentLoaded",function(){y()});
